<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸŽ¯ Cypha Bingo - Big Screen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/css/bigscreen.css" />
  <!-- Lightweight QR generator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
</head>
<body>

  <!-- HUD: Live pill only (removed QR card here) -->
  <div id="hud">
    <div class="live-pill" id="live-pill">
      <span class="dot"></span><span class="label">STANDBY</span>
    </div>
    <!-- Announcement Bar (Ticker) DIRECTLY BELOW LIVE PILL -->
    <div id="announcement-bar" class="announcement-bar"><span id="announcement-text">Welcome to Cypha Bingo!</span></div>
  </div>

  <!-- Bottom-right QR only -->
  <div id="qr-container">
    <div id="qrcode-br"></div>
    <div id="qr-caption">bingo.cyphaent.com</div>
  </div>

  <div id="bigscreen-wrapper">
    <h1 id="bingo-title">ðŸŽ¶ Now Playing</h1>
    <div id="current-song">Waiting for host...</div>

    <div id="recent-songs-title">ðŸ•˜ Previously Called</div>
    <ul id="recent-songs"></ul>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <!-- Single QRCode library include (moved here, once) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>

    const socket = io();

    // DOM refs
    const currentSongEl = document.getElementById('current-song');
    const recentSongsEl = document.getElementById('recent-songs');
    const livePill      = document.getElementById('live-pill');
    const qrCaptionEl   = document.getElementById('qr-caption');
    const announcementText = document.getElementById('announcement-text');

    // Listen for announcement updates from host
    socket.on('announcement', txt => {
      if (announcementText) announcementText.textContent = (txt ?? '');
    });


    // Join URL (edit if you want a different path)
    const JOIN_URL = "https://bingo.cyphaent.com";

    // Build the bottom-right QR once
    window.addEventListener("load", () => {
      qrCaptionEl.textContent = JOIN_URL;
      try {
        // eslint-disable-next-line no-undef
        new QRCode(document.getElementById("qrcode-br"), {
          text: JOIN_URL,
          width: 196,
          height: 196,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.M
        });
      } catch (e) {
        document.getElementById("qrcode-br").innerHTML =
          '<div class="qr-fallback">Scan disabled â€” visit:<br>'+JOIN_URL+'</div>';
      }
    });

    // Live pill state
    function setLive(isLive) {
      livePill.classList.toggle('on', !!isLive);
      livePill.querySelector('.label').textContent = isLive ? 'LIVE NOW' : 'STANDBY';
    }
    setLive(false);

    // Recently called logic
    const maxRecent = 5;
    const recentSongs = [];
    let lastSong = null;

    socket.on('broadcastSong', (songTitle) => {
      if (lastSong && lastSong !== songTitle) {
        if (recentSongs.length >= maxRecent) recentSongs.shift();
        recentSongs.push(lastSong);
      }
      lastSong = songTitle;
      currentSongEl.textContent = songTitle;

      recentSongsEl.innerHTML = '';
      recentSongs.slice().reverse().forEach(song => {
        const li = document.createElement('li');
        li.textContent = song;
        recentSongsEl.appendChild(li);
      });

      setLive(true);
    });

    socket.on('clear-bigscreen', () => {
      recentSongs.length = 0;
      recentSongsEl.innerHTML = '';
      currentSongEl.textContent = 'Waiting for host...';
      lastSong = null;
      setLive(false);
    });
  </script>
</body>
</html>
